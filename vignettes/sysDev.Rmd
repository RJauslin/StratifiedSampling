---
title: "Deville Systematic"
author: "RaphaÃ«l Jauslin"
date: "`r Sys.Date()`"
output: 
  prettydoc::html_pretty:
    theme: architect
    highlight: github
bibliography: ref.bib
vignette: > 
  %\VignetteIndexEntry{Deville Systematic}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
  
```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
# library(StratifiedSampling)

```


## Introduction

The Deville systematic design is a sampling design developed in 1998 by Jean-Claude Deville. The method has similarities with the systematic design but has different properties. @cha:12 has shown that Deville systematic and ordered pivotal method are in fact the same underlying sampling design. This vignette shows how to use the functions `sys_deville` and `sys_devillepi2`. A small simulation is also computed to see that the second order inclusion probabilities are effectively the same as the function `spm` of the package BalancedSampling that compute the ordered pivotal method. 


## Generate data

Inclusion probabilities are generated unequal and proportional to a random uniform variable.
```{r}
library(sampling)
library(StratifiedSampling)
library(BalancedSampling)
devtools::load_all(".")
set.seed(1)
N <- 20
n <- 3
pik <- inclusionprobabilities(runif(N),n)

```


## Simulations

To see if the function indeed computes the correct second-order inclusion probabilities, we perform a large number of simulations to estimate the second-order inclusion probability matrix. 

```{r}

SIM <- 100000
PI_1 <-  PI_2 <-  matrix(rep(0,N*N),ncol = N,nrow = N)

for(i in 1:SIM){
  
  s1 <- BalancedSampling::spm(pik)
  s1_01 <- rep(0,N)
  s1_01[s1] <- 1
  
  s2 <- sys_deville(pik)
  s2_01 <- rep(0,N)
  s2_01[s2] <- 1
  PI_1 <- PI_1 + s1_01%*%t(s1_01)
  PI_2 <- PI_2 + s2_01%*%t(s2_01)

}

PI_1 <- PI_1/SIM
PI_2 <- PI_2/SIM

```


## Exact matrix of second order inclusion
The function `sys_devillepi2` computes the exact second order inclusion probabilities. 

```{r}
PI <- sys_devillepi2(pik) # compute the second order inclusion probabilities
```

## Results

```{r}

PI_1_sp <- as(as.matrix(PI_1),"sparseMatrix")
PI_2_sp <- as(as.matrix(PI_2),"sparseMatrix")
PI_sp <- as(as.matrix(PI),"sparseMatrix")

image(PI_1_sp)
image(PI_2_sp)
image(PI_sp)


# proportional test, these values should be approximately to 0.95
length( which(abs((PI_1_sp@x - PI_sp@x)/sqrt(PI_sp@x*(1-PI_sp@x)/SIM)) < 1.96))/length(PI_sp@x)
length( which(abs((PI_2_sp@x - PI_sp@x)/sqrt(PI_sp@x*(1-PI_sp@x)/SIM)) < 1.96))/length(PI_sp@x)

```

## References

