---
title: "Proporitonal Allocation Swiss Establishement"
author: "RaphaÃ«l Jauslin"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Proporitonal Allocation establishement}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
# library(StratifiedSampling)
 devtools::load_all("C:/Users/jauslinr/switchdrive/StratifiedSampling/StratifiedSampling")
```


## Data loading
For this example we will use the dataset `establishement` contained in the package `StratifiedSampling`. The dataset is a small part of size $N = 2505$ of a bigger dataset that could be found for free (https://www.bfs.admin.ch/bfs/fr/home/services/geostat/geodonnees-statistique-federale/etablissements-emplois/statistique-structurel-entreprises-statent-depuis-2011.assetdetail.14027644.html). It was collected by the Swiss Federal Statistical Office.

The aim of this tutorial will be to compute a sample of size 260 using proportional allocation with respect to the number of units in each canton. Firstly we need to load the dataset using the command: 

```{r}
data(establishement)
N <- nrow(establishement)
N
n <- 260
strata <- establishement$Kanton
```


## Inclusion probabilities

In order to compute inclusion probabilities with proportional allocation, we need to compute the expect size in each canton and use the function `inclusionprobstrata` of the package `sampling`. We get then 

```{r}
Nh <- table(strata) # numer of units in each canton
Nh
nh <- n*Nh/N
nh
pik <- as.vector(inclusionprobastrata(strata,nh))

```


## sample selection and plot
Once we have the inclusion probabilities and the strata vector. It is very simple to use the function `stratifiedcube`,

```{r}
X <- as.matrix(as.vector(pik))
s <- stratifiedcube(X,strata,pik)
```


```{r, fig.width=10,fig.height=10}

data("SwissCanton_LV95")
data("SwissLake_LV95")

t(X/pik)%*%pik
t(X/pik)%*%s

Xcat <- disj(as.matrix(strata)) #disjunctive form of strata

t(Xcat)%*%pik
t(Xcat)%*%s

library(ggplot2)
library(viridis)
ggplot()+
  geom_sf(data = SwissLake_LV95,fill = "lightskyblue",color = "grey40",size = 0.5)+
  geom_sf(data = SwissCanton_LV95,aes(fill = KtName),color = "grey40",size = 0.5)+
  geom_point(data = establishement,
             aes(x=E_KOORD,y = N_KOORD),
             shape = 1,
             size = 1,
             colour = "black")+
  geom_point(data = establishement[s == 1,],
             aes(x=E_KOORD,y = N_KOORD),
             shape = 16,
             colour = "black",
             size = 1)+
  theme_bw()+
  theme(legend.position="bottom")+
  scale_fill_viridis_d()
```





