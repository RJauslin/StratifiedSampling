//' @encoding UTF-8
//' @title Variance Estimation for balanced sample
//' 
//' @description
//' Estimated variance approximation calculated as the conditional variance with respect to the balancing equations of a particular Poisson design. See Tillé (2020)
//' 
//' 
//' @param Xaux Matrix of balancing constraints.
//' @param pik Vector of inclusion probabilities.
//' @param y variable of interest.
//' @param s sample
//' 
//' @references 
//' Tillé, Y. (2020), Sampling and Estimation from finite populations, Wiley,
//'
//' @return Estimated variance of the horvitz-thompson estimator.
//' 
//' @author Raphaël Jauslin \email{raphael.jauslin@@unine.ch}
//' 
//' @export
// [[Rcpp::export]]
arma::mat vEst(arma::mat Xaux,
               arma::vec pik,
               arma::vec y,
               arma::vec s) {
  int n = arma::sum(s);
  int p = Xaux.n_cols;
  
  arma::uvec idx = find(s == 1);
  arma::mat A = arma::diagmat(1.0/pik.elem(idx))*Xaux.rows(idx);
  
  
  arma::vec c =(1.0*n/(n-p))*(1.0-pik.elem(idx));
  arma::mat D = arma::diagmat(c);
  arma::mat XX = arma::pinv(A.t()*D*A);
  
  arma::mat proj = A*XX*A.t()*D;
  
  arma::vec pred = proj*(y.elem(idx)/pik.elem(idx));
  arma::vec diff = y.elem(idx)/pik.elem(idx) - pred;
  arma::mat out = diff.t()*D*diff;
  
  return(out);
  
}